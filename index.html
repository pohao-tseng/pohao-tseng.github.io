<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO-HAO TSENG | 意義場 V4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
        :root {
            --bg-color: #020202; /* 極致黑 */
            --text-color: #e0e0e0;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-color);
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-layer {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .interactive {
            pointer-events: auto;
        }

        /* Landing Screen */
        #landing-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 100%);
            transition: opacity 1.5s ease;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 15px;
            font-size: 1rem;
            margin-bottom: 3rem;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
        }

        #enter-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 15px 60px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.5s ease;
            letter-spacing: 3px;
        }

        #enter-btn:hover {
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        /* Nav */
        nav {
            position: absolute;
            bottom: 50px;
            left: 50px;
            display: flex;
            flex-direction: row;
            gap: 40px;
            opacity: 0;
            transform: translateY(20px);
        }

        .nav-link {
            text-decoration: none;
            color: #666;
            font-size: 0.8rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            color: #fff;
            text-shadow: 0 0 8px rgba(255,255,255,0.6);
        }

        /* Content */
        .content-section {
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.8) 30%);
            display: none;
            opacity: 0;
            padding: 100px 50px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .content-section.active {
            display: block;
        }

        .text-block {
            margin-top: 20%;
        }

        .text-block h2 {
            font-weight: 200;
            font-size: 2rem;
            margin-bottom: 30px;
            color: #fff;
            letter-spacing: 4px;
        }

        .text-block p {
            line-height: 1.8;
            font-size: 0.95rem;
            color: #bbb;
            margin-bottom: 20px;
            text-align: justify;
        }

        @media (max-width: 768px) {
            .content-section { width: 100%; background: rgba(0,0,0,0.8); }
            nav { bottom: 20px; left: 0; width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="landing-screen" class="interactive">
            <h1>PO-HAO TSENG</h1>
            <button id="enter-btn">ENTER FIELD</button>
            <p style="font-size:0.7rem; color:#555; margin-top:20px;">Audio Interactive Enabled</p>
        </div>

        <nav id="main-nav" class="interactive">
            <a class="nav-link" onclick="navigateTo('about')">ABOUT</a>
            <a class="nav-link" onclick="navigateTo('experiences')">EXPERIENCES</a>
            <a class="nav-link" onclick="navigateTo('gallery')">GALLERY</a>
        </nav>

        <div id="about" class="content-section interactive">
            <div class="text-block">
                <h2>意義場</h2>
                <p>角色、語言、空間與觀者同時運作的場域。</p>
                <p>在這裡，脈絡是流動的，如同這些粒子。每一個瞬間的交會都產生了暫時的結構，但隨即消散，重組為新的意義。</p>
                <p>請嘗試移動您的滑鼠並聆聽，聲音的振動正在重組這個場域的連結。</p>
            </div>
        </div>

        <div id="experiences" class="content-section interactive">
            <div class="text-block">
                <h2>經歷脈絡</h2>
                <p>2026 | 未命名的結構測試 [台北]</p>
                <p>2025 | 湧現的邊界 [台南藝術節]</p>
                <p>2023 | 駐村藝術家, 巴黎西帖</p>
            </div>
        </div>

        <div id="gallery" class="content-section interactive">
            <div class="text-block">
                <h2>視覺殘留</h2>
                <p>（作品集影像區域）</p>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer;
        let bgSystem, fgSystem; // 背景層, 前景層
        let linesMesh; // 線條
        let mouse = new THREE.Vector2(9999, 9999);
        let raycaster;
        
        // 音訊相關
        let sound, analyser, dataArray;
        let isAudioPlaying = false;

        // 參數設定
        const BG_COUNT = 4000;  // 背景粒子 (製造迷霧感)
        const FG_COUNT = 800;   // 前景粒子 (可互動)
        const CONNECTION_DIST = 60; // 連線距離
        const MOUSE_DIST = 200;     // 滑鼠觸發範圍

        function init() {
            const container = document.getElementById('canvas-container');
            
            // 1. 場景
            scene = new THREE.Scene();
            // 霧氣：距離感，讓遠處粒子模糊
            scene.fog = new THREE.FogExp2(0x020202, 0.0012);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
            camera.position.z = 500;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // 2. 材質生成 (極柔和的光暈)
            const softSprite = getSoftSprite();

            // 3. Layer 1: 背景層 (Deep Field) - 永遠摸不到，只有聲音能影響
            const bgGeometry = new THREE.BufferGeometry();
            const bgPos = [];
            const bgSizes = [];

            for (let i = 0; i < BG_COUNT; i++) {
                // 球體隨機分佈
                const r = 800 + Math.random() * 800; // 距離較遠 (800~1600)
                const theta = Math.random() * 2 * Math.PI;
                const phi = Math.acos(2 * Math.random() - 1);
                
                bgPos.push(
                    r * Math.sin(phi) * Math.cos(theta),
                    r * Math.sin(phi) * Math.sin(theta),
                    r * Math.cos(phi)
                );
                bgSizes.push(Math.random() * 3 + 1);
            }
            bgGeometry.setAttribute('position', new THREE.Float32BufferAttribute(bgPos, 3));
            bgGeometry.setAttribute('size', new THREE.Float32BufferAttribute(bgSizes, 1)); // 支援縮放

            const bgMaterial = new THREE.PointsMaterial({
                color: 0x444444, // 深灰
                size: 4,
                map: softSprite,
                blending: THREE.AdditiveBlending, // 疊加變亮
                depthWrite: false,
                transparent: true,
                opacity: 0.3
            });
            bgSystem = new THREE.Points(bgGeometry, bgMaterial);
            scene.add(bgSystem);


            // 4. Layer 2: 前景層 (Interactive) - V2的漂浮邏輯 + 神經連線
            const fgGeometry = new THREE.BufferGeometry();
            const fgPos = [];
            const fgVel = []; // 速度

            for (let i = 0; i < FG_COUNT; i++) {
                // 分佈在較近處 (-600 ~ 600)
                const x = (Math.random() - 0.5) * 1200;
                const y = (Math.random() - 0.5) * 1000;
                const z = (Math.random() - 0.5) * 800;
                fgPos.push(x, y, z);
                
                // V2 的漂浮速度
                fgVel.push({
                    x: (Math.random() - 0.5) * 0.4,
                    y: (Math.random() - 0.5) * 0.4,
                    z: (Math.random() - 0.5) * 0.4
                });
            }
            fgGeometry.setAttribute('position', new THREE.Float32BufferAttribute(fgPos, 3));
            
            const fgMaterial = new THREE.PointsMaterial({
                color: 0xaaccff, // 微微藍光
                size: 6,
                map: softSprite,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                opacity: 0.8
            });
            fgSystem = new THREE.Points(fgGeometry, fgMaterial);
            fgSystem.userData = { velocities: fgVel }; // 綁定速度資料
            scene.add(fgSystem);


            // 5. 連線系統 (Dynamic Lines)
            const lineGeo = new THREE.BufferGeometry();
            const lineMat = new THREE.LineBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.15,
                blending: THREE.AdditiveBlending
            });
            linesMesh = new THREE.LineSegments(lineGeo, lineMat);
            scene.add(linesMesh);

            // 6. 互動與監聽
            raycaster = new THREE.Raycaster();
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        // 建立音訊監聽器 (需在使用者點擊後觸發)
        function initAudio() {
            const listener = new THREE.AudioListener();
            camera.add(listener);

            sound = new THREE.Audio(listener);
            const audioLoader = new THREE.AudioLoader();
            
            // 載入音檔
            audioLoader.load('bgm.mp3', function(buffer) {
                sound.setBuffer(buffer);
                sound.setLoop(true);
                sound.setVolume(0.8);
                sound.play();
                isAudioPlaying = true;
            });

            // 建立分析器
            analyser = new THREE.AudioAnalyser(sound, 32); // 32 代表採樣精度，不用太高
        }

        // 柔和光暈貼圖
        function getSoftSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)');     // 中心白
            grad.addColorStop(0.2, 'rgba(255,255,255,0.8)'); // 過渡
            grad.addColorStop(0.5, 'rgba(255,255,255,0.2)'); // 外光暈
            grad.addColorStop(1, 'rgba(0,0,0,0)');           // 透明
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(canvas);
        }

        function onDocumentMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function animate() {
            requestAnimationFrame(animate);

            // --- 0. 取得音訊資料 ---
            let audioLevel = 1; // 預設值
            if (isAudioPlaying && analyser) {
                const data = analyser.getAverageFrequency(); // 0 ~ 255
                // 將 0~255 映射到 1.0 ~ 1.5 的縮放比例
                audioLevel = 1 + (data / 256) * 0.8;
                
                // 讓背景隨音樂稍微閃爍 (呼吸感)
                bgSystem.material.opacity = 0.3 + (data / 256) * 0.2;
                bgSystem.material.size = 4 * audioLevel;
            }

            // --- 1. 背景層動畫 (緩慢旋轉) ---
            bgSystem.rotation.y += 0.0005;
            bgSystem.rotation.x += 0.0002;

            // --- 2. 前景層動畫 (V2 漂浮 + 音訊加速) ---
            const positions = fgSystem.geometry.attributes.position.array;
            const velocities = fgSystem.userData.velocities;
            
            for (let i = 0; i < FG_COUNT; i++) {
                const ix = i * 3;
                
                // 加上速度 (如果有音樂，粒子會稍微興奮一點，移動快一點點)
                positions[ix]     += velocities[i].x * audioLevel;
                positions[ix + 1] += velocities[i].y * audioLevel;
                positions[ix + 2] += velocities[i].z * audioLevel;

                // 邊界循環 (Wrap around)
                if(positions[ix] > 600) positions[ix] = -600;
                if(positions[ix] < -600) positions[ix] = 600;
                if(positions[ix+1] > 500) positions[ix+1] = -500;
                if(positions[ix+1] < -500) positions[ix+1] = 500;
            }
            fgSystem.geometry.attributes.position.needsUpdate = true;
            
            // --- 3. 神經連線 (根據滑鼠位置) ---
            // 計算滑鼠在 3D 空間的投影線
            raycaster.setFromCamera(mouse, camera);
            const mousePos3D = new THREE.Vector3(mouse.x, mouse.y, 0.5);
            mousePos3D.unproject(camera);
            const dir = mousePos3D.sub(camera.position).normalize();
            const distance = -camera.position.z / dir.z;
            const targetPos = camera.position.clone().add(dir.multiplyScalar(distance));

            const linePositions = [];
            const p1 = new THREE.Vector3();
            const p2 = new THREE.Vector3();

            // 互動範圍也會隨著聲音變大！
            const activeDist = MOUSE_DIST * audioLevel;

            for (let i = 0; i < FG_COUNT; i++) {
                p1.set(positions[i*3], positions[i*3+1], positions[i*3+2]);
                
                // 只有當粒子靠近滑鼠時，才去檢查連線 (優化效能)
                if (p1.distanceTo(targetPos) < activeDist) {
                    
                    // 檢查鄰居
                    for (let j = i + 1; j < FG_COUNT; j++) {
                        p2.set(positions[j*3], positions[j*3+1], positions[j*3+2]);
                        
                        // 如果兩個粒子夠近，連線
                        if (p1.distanceTo(p2) < CONNECTION_DIST) {
                            linePositions.push(p1.x, p1.y, p1.z);
                            linePositions.push(p2.x, p2.y, p2.z);
                        }
                    }
                }
            }
            lineGeo.setAttribute('position', new THREE.Float32BufferAttribute(linePositions, 3));
            
            // 線條亮度也隨聲音變化
            linesMesh.material.opacity = 0.15 * audioLevel;

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- 點擊進入 ---
        document.getElementById('enter-btn').addEventListener('click', () => {
            initAudio(); // 啟動聲音分析

            // UI 動畫
            gsap.to('#landing-screen', { duration: 1.5, opacity: 0, pointerEvents: 'none' });
            gsap.to('nav', { duration: 1.5, opacity: 1, y: 0, delay: 0.5 });
            
            // 相機推進
            gsap.to(camera.position, { duration: 3, z: 400, ease: "power2.inOut" });
        });

        window.navigateTo = function(id) {
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.remove('active');
                gsap.to(el, { opacity: 0, duration: 0.5 });
            });
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            const target = document.getElementById(id);
            target.classList.add('active');
            gsap.to(target, { opacity: 1, duration: 1, delay: 0.5 });
        }

        init();
    </script>
</body>
</html>
